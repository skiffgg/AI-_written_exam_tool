<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="token" content="{{ token }}">
        <title>AI助手</title>
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
        <link rel="stylesheet" href="/static/style.css"> <script>
            window.API_BASE_URL = window.location.origin;
        </script>
        <!-- KaTeX 样式 -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">

        <!-- markdown-it 库，确保它在 auto-render 之前加载 -->
        <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js" crossorigin="anonymous"></script>

        <!-- KaTeX JavaScript 文件 -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>

        <!-- KaTeX 自动渲染功能 -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" 
                crossorigin="anonymous" onload="console.log('KaTeX auto-render.js v0.16.9 has loaded and should have executed.')"></script>

        <!-- Socket.io 库 -->
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

        
        <!-- 添加自定义 Markdown 渲染配置 -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // 配置 marked 选项
                if (typeof marked !== 'undefined') {
                    // 创建自定义渲染器
                    const renderer = new marked.Renderer();
                    
                    // 自定义标题渲染，处理数字标题格式
                    const originalHeadingRenderer = renderer.heading;
                    renderer.heading = function(text, level, raw, slugger) {
                        // 检查是否为数字标题格式（如 "3. 收银员"）
                        const match = text.match(/^(\d+)\.\s+(.+)$/);
                        if (match) {
                            const [_, number, content] = match;
                            return `<h${level} class="numbered-heading"><span class="heading-number">${number}.</span> <span class="heading-content">${content}</span></h${level}>`;
                        }
                        // 否则使用原始渲染器
                        return originalHeadingRenderer.call(this, text, level, raw, slugger);
                    };
                    
                    // 自定义列表项渲染
                    const originalListItemRenderer = renderer.listitem;
                    renderer.listitem = function(text, task, checked) {
                        // 移除列表项中不必要的段落标签
                        text = text.replace(/^<p>(.*)<\/p>$/, '$1');
                        return originalListItemRenderer.call(this, text, task, checked);
                    };
                    
                    // 设置 marked 选项
                    marked.setOptions({
                        renderer: renderer,
                        gfm: true,
                        breaks: true,
                        pedantic: false,
                        sanitize: false,
                        smartLists: true,
                        smartypants: false
                    });
                    
                    console.log('自定义 Markdown 渲染器已配置');
                }
            });
        </script>
        
        <!-- 确保 markdown-it 库正确加载 -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // 检查 markdown-it 是否可用
                if (typeof window.markdownit === 'function') {
                    console.log('markdown-it 库已成功加载');
                } else {
                    console.error('markdown-it 库未能加载，Markdown 渲染可能不可用');
                    // 尝试重新加载
                    const script = document.createElement('script');
                    script.src = "https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js";
                    script.crossOrigin = "anonymous";
                    script.referrerPolicy = "no-referrer";
                    script.onload = function() {
                        console.log('markdown-it 库已重新加载');
                        // 如果全局 md 变量已定义，重新初始化它
                        if (typeof initMarkdownRenderer === 'function') {
                            initMarkdownRenderer();
                        }
                    };
                    document.head.appendChild(script);
                }
            });
        </script>
        
        <!-- 添加 highlight.js 用于代码高亮 -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
        <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
        
        <!-- 添加直接检查脚本 -->
        <script>
            // 立即检查 markdown-it 是否可用
            (function() {
                if (typeof window.markdownit === 'function') {
                    console.log('✅ markdown-it 库已成功加载 (初始检查)');
                } else {
                    console.error('❌ markdown-it 库未能加载 (初始检查)');
                    // 立即尝试重新加载
                    const script = document.createElement('script');
                    script.src = "https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js";
                    script.integrity = "sha256-KvUKIGZRnNRYVpNZZA8OXkGJXPL3ZEGCRnCDFJPSCic=";
                    script.crossOrigin = "anonymous";
                    script.onload = function() {
                        console.log('✅ markdown-it 库已重新加载');
                    };
                    document.head.appendChild(script);
                }
            })();
        </script>
        
        </head>
<body>
    <div class="container-fluid">
        <header class="header">
            <div class="header-left">
                 <h1>AI助手</h1>
                 <p>截图分析 · AI对话 · 语音回答</p>
            </div>
             <div class="header-right">
                 <span id="api-provider" class="provider-info" title="当前使用的AI模型提供商">AI模型: 加载中...</span>
                 <div class="status-item" title="与服务器的实时连接状态">
                     <div id="connection-indicator" class="status-indicator disconnected"></div>
                     <span id="connection-status">实时连接: 未连接</span>
                 </div>
            </div>
        </header>

        <nav class="tabs-container">
            <button class="tab-item active" data-tab="screenshot-analysis" title="上传截图进行分析">
                <i class="fas fa-camera-retro me-1"></i> 截图分析
            </button>
            <button class="tab-item" data-tab="ai-chat" title="与AI进行文本或文件对话">
                <i class="fas fa-comments me-1"></i> AI对话
            </button>
            <button class="tab-item" data-tab="voice-answer" title="通过语音与AI交互">
                <i class="fas fa-microphone-alt me-1"></i> 语音回答
            </button>
        </nav>

        <div class="tab-content-wrapper">
            <section class="tab-content active" id="screenshot-analysis" aria-labelledby="tab-screenshot-analysis">
                <div class="main-content">
                    <aside class="left-panel">
                        <div class="panel-title">
                            <span><i class="fas fa-history me-2"></i>截图历史</span>
                            <button id="ss-clear-history" class="btn btn-sm btn-danger" title="清空截图历史记录">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <button id="ss-capture-btn" class="btn btn-primary mb-3 w-100">
                            <i class="fas fa-camera me-2"></i>发起截屏
                        </button>
                        <ul id="ss-history-list" class="history-list"></ul>
                    </aside>
                    <main class="right-panel">
                        <div class="analysis-card">
                            <h3 class="panel-title"><i class="fas fa-lightbulb me-2"></i>AI分析结果</h3>
                            <div id="ss-ai-analysis" class="ai-analysis">
                                请在左侧点击历史记录查看分析结果，或点击“发起截屏”进行分析。
                            </div>
                        </div>
                    </main>
                </div>
            </section>

            <section class="tab-content" id="ai-chat" aria-labelledby="tab-ai-chat">
                <div class="main-content">
                    <aside class="left-panel">
                         <div class="panel-title">
                            <span><i class="fas fa-book me-2"></i>对话记录</span>
                            <button id="chat-clear-all-sessions" class="btn btn-sm btn-danger" title="清空所有对话记录">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <ul id="chat-session-list" class="history-list"></ul>
                        <button id="chat-clear-current-chat" class="btn btn-secondary mt-3 w-100" title="清空当前显示，开始新对话">
                             <i class="fas fa-eraser me-2"></i>新对话/清空显示
                        </button>
                    </aside>
                    <main class="right-panel">
                        <div class="chat-card">
                            <h3 class="panel-title"><i class="fas fa-comments me-2"></i>AI对话</h3>
                            <div id="chat-chat-history" class="ai-analysis chat-messages">
                                <div class="system-message">选择左侧记录或开始新对话...</div>
                            </div>
                            <div class="chat-input-container">
                                 <div id="chat-upload-preview" class="upload-preview"></div>
                                 <textarea id="chat-chat-input" placeholder="输入您的问题... (Shift+Enter 换行)"></textarea>
                                 <div class="chat-controls">
                                     <div class="chat-file-upload-container">
                                         <label for="chat-file-upload" class="file-upload-label" title="附加文件">
                                             <i class="fas fa-paperclip"></i>
                                             <span>附加文件</span>
                                         </label>
                                         <input type="file" id="chat-file-upload"> </div>
                                     <div class="chat-buttons">
                                         <div class="streaming-toggle" title="开启/关闭流式输出">
                                             <input type="checkbox" id="streaming-toggle-checkbox" checked>
                                             <label for="streaming-toggle-checkbox">流式输出</label>
                                         </div>
                                         <button id="chat-send-chat" class="btn btn-primary" title="发送消息">
                                             <i class="fas fa-paper-plane"></i> 发送
                                         </button>
                                         </div>
                                 </div>
                            </div>
                        </div>
                    </main>
                </div>
            </section>

            <section class="tab-content" id="voice-answer" aria-labelledby="tab-voice-answer">
                 <div class="main-content">
                     <aside class="left-panel">
                         <div class="panel-title">
                             <span><i class="fas fa-history me-2"></i>语音历史</span>
                             <button id="voice-clear-history" class="btn btn-sm btn-danger" title="清空语音历史记录">
                                 <i class="fas fa-trash"></i>
                             </button>
                         </div>
                         <ul id="voice-history-list" class="history-list"></ul>
                     </aside>
                     <main class="right-panel">
                         <div class="voice-card">
                             <h3 class="panel-title"><i class="fas fa-microphone-alt me-2"></i>语音对话</h3>
                             <div id="voice-result" class="ai-analysis">
                                 点击下方按钮开始录音，识别结果和 AI 回答将显示在此处。
                             </div>
                             <div class="voice-controls">
                                 <button id="voice-start-recording" class="btn btn-primary">
                                     <i class="fas fa-microphone"></i> 开始录音
                                 </button>
                                 <button id="voice-stop-recording" class="btn btn-secondary" disabled>
                                     <i class="fas fa-stop"></i> 停止录音
                                 </button>
                             </div>
                         </div>
                     </main>
                 </div>
            </section>
        </div> </div> <div id="overlay" class="overlay">
         <button id="close-overlay" class="close-btn" title="关闭">&times;</button>
         <div class="overlay-content">
             <div class="image-container">
                 <img id="overlay-image" class="overlay-image" src="" alt="截图预览">
                 <div id="selection-box" class="selection-box"></div>
             </div>
             <div class="overlay-controls">
                 <div id="crop-info" class="crop-info">拖拽选框调整区域</div>
                 <div class="prompt-container">
                     <label for="prompt-input">针对选中区域的提问 (可选):</label>
                     <input type="text" id="prompt-input" placeholder="例如：解释这部分代码的功能...">
                 </div>
                 <div class="buttons">
                     <button id="cancel-selection" class="btn btn-secondary">
                         <i class="fas fa-times me-1"></i>取消
                     </button>
                     <button id="confirm-selection" class="btn btn-primary">
                         <i class="fas fa-crop-alt me-1"></i>确认裁剪并分析
                     </button>
                 </div>
             </div>
         </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script src="/static/main.js"></script>

</body>
</html>
