/* server/static/style.css */

/* =====================================================================
   Global Theme Variables
   ===================================================================== */
:root {
    /* --- Base Colors & Layout --- */
    --primary-color: #4a6baf;
    --primary-light: #7a97d5;
    --primary-dark: #2a4a8f;
    --accent-color: #ff7043;
    --text-color: #333333;          /* Major text color */
    --light-text: #555555;        /* Secondary text color */
    --bg-color: #f4f7f6;            /* Main page background */
    --card-bg: #ffffff;           /* Background for cards, panels, etc. */
    --border-radius: 8px;
    --shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    --transition: all 0.2s ease-in-out;
    --font-family-sans-serif: 'Roboto', 'Microsoft YaHei', Arial, sans-serif;
    --font-family-monospace: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    --primary-color-rgb: 74, 107, 175; /* For box-shadow with opacity */

    /* --- Header --- */
    --header-bg-start: var(--primary-color);
    --header-bg-end: var(--primary-dark);
    --header-text-color: #ffffff;
    --header-icon-btn-border-color: rgba(255,255,255,.3);
    --header-icon-btn-hover-bg: rgba(255,255,255,.1);
    --header-icon-btn-color: rgba(255,255,255,.8);
    --header-info-bg: rgba(255,255,255,.1);
    --header-info-text-color: rgba(255,255,255,.8);
    --header-info-border-color: rgba(255,255,255,.3);

    /* --- Tabs --- */
    --tab-bg: #e9ecef;
    --tab-text-color: var(--light-text);
    --tab-active-text-color: var(--primary-color);
    --tab-active-border-color: var(--primary-color);
    --tab-hover-text-color: var(--text-color);
    --tab-bottom-border-color: #dee2e6;

    /* --- Panels & Cards (Sidebar, Main Content Cards) --- */
    --panel-border-color: #e0e0e0;
    --panel-title-text-color: var(--primary-color);
    --panel-title-border-color: #dddddd;

    /* --- History Items --- */
    --history-item-bg: #f8f9fa;
    --history-item-border-color: #eeeeee;
    --history-item-hover-bg: #f1f3f5;
    --history-item-active-bg: #e0e7ff;
    --history-item-active-border-color: var(--primary-color);
    --history-item-text-main-color: var(--text-color);
    --history-item-text-secondary-color: #6c757d;
    --history-item-delete-btn-color: #dc3545c2;
    --history-item-delete-btn-hover-bg: rgba(220,53,69,.1);
    --history-item-delete-btn-hover-color: #dc3545;

    /* --- AI Analysis / Chat Area --- */
    --ai-analysis-bg: #f8f9fa;
    --ai-analysis-border-color: #eeeeee;
    --ai-analysis-text-color: var(--text-color);

    /* --- Messages --- */
    --user-message-bg: #d1e7fd;
    --user-message-text-color: #084298;
    --ai-message-bg: #e9ecef;
    --ai-message-text-color: #343a40;
    --ai-message-strong-color: var(--primary-dark);
    --system-message-text-color: #6c757d;
    --error-message-bg: #f8d7da;
    --error-message-text-color: #842029;
    --error-message-border-color: #f5c2c7;
    --attached-file-bg: rgba(0,0,0,.05);
    --attached-file-text-color: #495057;
    --attached-file-border-color: rgba(0,0,0,.08);
    --ai-thinking-bg: var(--ai-message-bg);
    --ai-thinking-text-color: var(--light-text);

    /* --- Inputs & Controls --- */
    --input-bg: #ffffff;
    --input-border-color: #cccccc;
    --input-text-color: var(--text-color);
    --input-focus-border-color: var(--primary-color);
    --input-focus-shadow: rgba(var(--primary-color-rgb),.25);
    --input-placeholder-color: #6c757d;
    --chat-controls-border-top-color: #eeeeee;
    --file-upload-label-bg: #f0f0f0;
    --file-upload-label-border-color: #cccccc;
    --file-upload-label-text-color: #555555;
    --file-upload-label-hover-bg: #e0e0e0;
    --file-upload-label-hover-text-color: #333333;
    --preview-item-bg: #e9ecef;
    --preview-item-border-color: #dee2e6;
    --preview-item-text-color: #495057;
    --preview-item-icon-color: #6c757d;
    --remove-file-btn-text-color: #6c757d;
    --remove-file-btn-hover-text-color: #dc3545;
    --streaming-toggle-text-color: var(--light-text);

    /* --- Buttons --- */
    --button-primary-text-color: #ffffff;
    --button-secondary-bg: #6c757d;
    --button-secondary-text-color: #ffffff;
    --button-secondary-hover-bg: #5a6268;
    --button-danger-bg: #dc3545;
    --button-danger-text-color: #ffffff;
    --button-danger-hover-bg: #c82333;
    --button-outline-primary-text-color: var(--primary-color);
    --button-outline-primary-border-color: var(--primary-color);
    --button-outline-primary-hover-bg: var(--primary-color);
    --button-outline-primary-hover-text-color: #ffffff;
    --button-outline-secondary-text-color: #6c757d;
    --button-outline-secondary-border-color: #6c757d;
    --button-outline-secondary-hover-bg: #6c757d;
    --button-outline-secondary-hover-text-color: #ffffff;

    /* --- Scrollbars --- */
    --scrollbar-thumb-color: #cccccc;
    --scrollbar-track-color: transparent;

    /* --- Code Blocks & Markdown --- */
    --code-bg: rgba(0,0,0,.06);
    --code-text-color: #c7254e;
    --pre-bg: #f0f0f0;
    --pre-border-color: #dddddd;
    --pre-text-color: var(--text-color);
    --copy-button-bg: #e0e0e0;
    --copy-button-text-color: #555555;
    --copy-button-border-color: #cccccc;
    --copy-button-hover-bg: #528bff;
    --copy-button-hover-text-color: #ffffff;
    --copy-button-copied-bg: #28a745;
    --copy-button-failed-bg: #dc3545;
    --table-border-color: #d0d7de;
    --table-header-bg: #f6f8fa;
    --table-row-even-bg: #fdfdfd;
    --blockquote-bg: #f8f9fa;
    --blockquote-border-color: #d0d7de;
    --blockquote-text-color: #586069;

    /* --- KaTeX --- */
    --katex-display-bg: rgba(233,236,239,.6);

    /* --- Overlay / Cropper --- */
    --overlay-backdrop-bg: rgba(0,0,0,.85);
    --overlay-content-bg: var(--card-bg);
    --overlay-controls-bg: #f8f9fa;
    --overlay-controls-border-color: #e0e0e0;
    --overlay-close-btn-bg: rgba(0,0,0,.4);
    --overlay-close-btn-text-color: #ffffff;
    --overlay-close-btn-hover-bg: rgba(0,0,0,.7);
    --overlay-image-container-bg: #333333;
    --selection-box-border-color: #f0f0f0;
    --selection-box-bg-color: rgba(var(--primary-color-rgb),.2);
    --selection-box-shadow-color: rgba(0,0,0,.6);
    --resize-handle-bg: rgba(var(--primary-color-rgb),.5);
    --crop-info-text-color: #555555;

    --sidebar-width: 280px; /* 侧栏默认宽度 */
}

/* =====================================================================
   Dark Theme Variables
   ===================================================================== */
body.theme-dark {
    --primary-color: #5c85d6;
    --primary-light: #8aaef2;
    --primary-dark: #3e64b4;
    --accent-color: #ff8a65;
    --text-color: #e0e0e0;          /* Major text color for dark theme (light) */
    --light-text: #b0b0b0;        /* Secondary text color for dark theme (lighter) */
    --bg-color: #121212;            /* Main page background for dark theme */
    --card-bg: #1e1e1e;           /* Background for cards, panels, etc. for dark theme */
    --primary-color-rgb: 92, 133, 214; /* RGB for primary color in dark theme */

    /* --- Header --- */
    --header-bg-start: #2c3e50;
    --header-bg-end: #1f2b38;
    --header-text-color: #eceff1;
    --header-icon-btn-border-color: rgba(236,239,241,.3);
    --header-icon-btn-hover-bg: rgba(236,239,241,.1);
    --header-icon-btn-color: rgba(236,239,241,.8);
    --header-info-bg: rgba(0,0,0,.3);
    --header-info-text-color: rgba(236,239,241,.8);
    --header-info-border-color: rgba(236,239,241,.4);

    /* --- Tabs --- */
    --tab-bg: #252525;
    --tab-text-color: var(--light-text); /* Use dark theme's light text */
    --tab-active-text-color: var(--primary-color); /* Use dark theme's primary */
    --tab-active-border-color: var(--primary-color);
    --tab-hover-text-color: var(--text-color); /* Use dark theme's main text */
    --tab-bottom-border-color: #383838;

    /* --- Panels & Cards --- */
    --panel-border-color: #333333;
    --panel-title-text-color: var(--primary-color);
    --panel-title-border-color: #444444;

    /* --- History Items --- */
    --history-item-bg: #2a2a2a;
    --history-item-border-color: #383838;
    --history-item-hover-bg: #333333;
    --history-item-active-bg: #2c3e50;
    --history-item-active-border-color: var(--primary-color);
    --history-item-text-main-color: var(--text-color);
    --history-item-text-secondary-color: #909090;
    --history-item-delete-btn-color: #ff8a80c2;
    --history-item-delete-btn-hover-bg: rgba(255,138,128,.1);
    --history-item-delete-btn-hover-color: #ff8a80;

        /* Bootstrap 基础 */
    --bs-body-bg:        #121212;
    --bs-body-color:     #e0e0e0;
    --bs-body-tertiary:  #1e1e1e;
    --bs-tertiary-bg:    #272b30;
    --bs-secondary-color:#b0b0b0;
    --bs-border-color-translucent:#40454a;

        /* 全局 Bootstrap 边框基准 */
    --bs-border-color:            rgba(255,255,255,0.06);
    --bs-border-color-translucent:rgba(255,255,255,0.06);   /* 关键：让所有用 translucent 的地方一起变暗 */

    /* 任选：把你自己的统一变量也同步一下 */
    --panel-border-color:         rgba(255,255,255,0.06);

    /* 可选：主品牌色同步深色主色 */
    --bs-primary: #5c85d6;

    /* --- AI Analysis / Chat Area --- */
    --ai-analysis-bg: #252525;
    --ai-analysis-border-color: #383838;
    --ai-analysis-text-color: var(--text-color);

    /* --- Messages --- */
    --user-message-bg: #2c3e50;
    --user-message-text-color: var(--text-color); /* Use main dark theme text color */
    --ai-message-bg: #333333;
    --ai-message-text-color: var(--text-color); /* Use main dark theme text color */
    --ai-message-strong-color: var(--primary-light);
    --system-message-text-color: #909090;
    --error-message-bg: #5e2129;
    --error-message-text-color: #ffcdd2;
    --error-message-border-color: #b71c1c;
    --attached-file-bg: rgba(255,255,255,.1);
    --attached-file-text-color: var(--light-text);
    --attached-file-border-color: rgba(255,255,255,.15);
    --ai-thinking-bg: var(--ai-message-bg);
    --ai-thinking-text-color: var(--light-text);

    /* --- Inputs & Controls --- */
    --input-bg: #2c2c2c;
    --input-border-color: #444444;
    --input-text-color: var(--text-color); /* Ensure input text is light */
    --input-focus-border-color: var(--primary-color);
    --input-focus-shadow: rgba(var(--primary-color-rgb),.3);
    --input-placeholder-color: #757575;
    --chat-controls-border-top-color: #383838;
    --file-upload-label-bg: #3a3a3a;
    --file-upload-label-border-color: #444444;
    --file-upload-label-text-color: #b0b0b0;
    --file-upload-label-hover-bg: #4f4f4f;
    --file-upload-label-hover-text-color: var(--text-color);
    --preview-item-bg: #3a3a3a;
    --preview-item-border-color: #444444;
    --preview-item-text-color: var(--light-text);
    --preview-item-icon-color: #909090;
    --remove-file-btn-text-color: #909090;
    --remove-file-btn-hover-text-color: #ff8a80;
    --streaming-toggle-text-color: var(--light-text);

    /* --- Buttons --- */
    --button-primary-text-color: #ffffff;
    --button-secondary-bg: #4f4f4f;
    --button-secondary-text-color: #ffffff;
    --button-secondary-hover-bg: #616161;
    --button-danger-bg: #a02d37;
    --button-danger-text-color: #ffffff;
    --button-danger-hover-bg: #c62828;
    --button-outline-primary-text-color: var(--primary-color);
    --button-outline-primary-border-color: var(--primary-color);
    --button-outline-primary-hover-bg: var(--primary-color);
    --button-outline-primary-hover-text-color: var(--bg-color);
    --button-outline-secondary-text-color: var(--light-text);
    --button-outline-secondary-border-color: var(--light-text);
    --button-outline-secondary-hover-bg: var(--light-text);
    --button-outline-secondary-hover-text-color: var(--bg-color);

    /* --- Scrollbars --- */
    --scrollbar-thumb-color: #555555;
    --scrollbar-track-color: #2c2c2c; /* Or var(--card-bg) */

    /* --- Code Blocks & Markdown --- */
    --code-bg: rgba(255,255,255,.1);
    --code-text-color: #ffcc80;
    --pre-bg: #2b2b2b;
    --pre-border-color: #4d4d4d;
    --pre-text-color: #c5c8c6;
    --copy-button-bg: #3a3f44;
    --copy-button-text-color: #9da5b4;
    --copy-button-border-color: #282c34;
    --copy-button-hover-bg: var(--primary-color);
    --copy-button-hover-text-color: var(--bg-color);
    --copy-button-copied-bg: #387a47;
    --copy-button-failed-bg: #a02d37;
    --table-border-color: #444444;
    --table-header-bg: #2a2a2a;
    --table-row-even-bg: #252525;
    --blockquote-bg: #2a2a2a;
    --blockquote-border-color: #444444;
    --blockquote-text-color: #a0a0a0;

    /* --- KaTeX --- */
    --katex-display-bg: rgba(40,44,52,.7);

    /* --- Overlay / Cropper --- */
    --overlay-backdrop-bg: rgba(0,0,0,.92);
    --overlay-content-bg: var(--card-bg);
    --overlay-controls-bg: #252525;
    --overlay-controls-border-color: #333333;
    --overlay-close-btn-bg: rgba(255,255,255,.1);
    --overlay-close-btn-text-color: #eeeeee;
    --overlay-close-btn-hover-bg: rgba(255,255,255,.2);
    --overlay-image-container-bg: #1a1a1a;
    --selection-box-border-color: var(--primary-light);
    --selection-box-bg-color: rgba(var(--primary-color-rgb),.25);
    --selection-box-shadow-color: rgba(0,0,0,.75);
    --resize-handle-bg: rgba(var(--primary-color-rgb),.6);
    --crop-info-text-color: var(--light-text);

    /* === Specific Fixes for Dark Theme Icons & Controls === */
    .left-panel-top-controls .btn-icon {
        color: var(--light-text); /* Use a light color for icons on dark panel */
    }
    .left-panel-top-controls .btn-icon:hover {
        color: var(--primary-light); /* Brighter on hover */
    }
    .left-panel-top-controls .search-history-input {
        background-color: #272b30; /* Darker background for input */
        border-color: #40454a;    /* Darker border */
        color: var(--text-color);      /* Light text color for input */
    }
    .left-panel-top-controls .search-history-input::placeholder {
        color: #6c757d; /* Placeholder text color */
    }
    #chat-attach-file-btn {
        color: var(--light-text); /* Make attach icon lighter */
    }
    #chat-attach-file-btn:hover {
        color: var(--primary-light);
    }
     #chat-send-chat {
        color: var(--primary-light); /* Send icon color */
    }
    #chat-send-chat:hover {
        color: var(--primary-color);
    }
}


/* =====================================================================
   Reset & Base Layout
   ===================================================================== */
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px;height:100%}
body{
    font-family:var(--font-family-sans-serif);
    background:var(--bg-color);
    color:var(--text-color);
    line-height:1.6;
    font-size:.95rem;
    min-height:100%;
    display:flex;
    flex-direction:column;
    transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transition */
}
.container-fluid{flex:1 1 auto;display:flex;flex-direction:column;overflow:hidden;padding:0}

/* =====================================================================
   Header
   ===================================================================== */
.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-shrink:0;
    padding:.8rem 1.5rem;
    color:var(--header-text-color);
    background:linear-gradient(135deg,var(--header-bg-start) 0%,var(--header-bg-end) 100%);
    box-shadow:0 2px 5px rgba(0,0,0,.15);
    position:relative;
    z-index:10
}
.header-left{display:flex;align-items:center}
.header-left h1{margin:0;font-size:1.4rem;font-weight:600;text-shadow:1px 1px 2px rgba(0,0,0,.1)}
.header-left p{margin:.1rem 0 0 .5rem;padding-left:.5rem;font-size:.85rem;opacity:.9;border-left:1px solid var(--header-icon-btn-border-color)}
.header-right{display:flex;align-items:center;gap:1rem}

/* Style for the new global sidebar toggle button in the header */
/* You can use an ID if it's unique, or a class like .btn-icon-header */
#global-sidebar-toggle.btn-icon-header { /* Or just .btn-icon-header if you add this class to the button */
    background: transparent;
    border: 1px solid var(--header-icon-btn-border-color);
    color: var(--header-icon-btn-color);
    padding: 0.3rem 0.6rem; /* Adjust as needed */
    font-size: 0.9rem;     /* Adjust as needed */
    border-radius: var(--bs-border-radius-sm); /* Bootstrap small border radius */
    line-height: 1; /* Ensure icon is centered */
    /* margin-right: 0.75rem; /* Optional: if you want space like the old #toggle-sidebar-btn */
}
#global-sidebar-toggle.btn-icon-header:hover {
    background: var(--header-icon-btn-hover-bg);
    color: var(--header-text-color);
}
/* Remove styles for the old #toggle-sidebar-btn if it's no longer used, or ensure they don't conflict */
/*
#toggle-sidebar-btn{
    margin-right:.75rem;
    padding:.25rem .5rem;
    line-height:1;
    background:transparent;
    border:1px solid var(--header-icon-btn-border-color);
    color:var(--header-icon-btn-color);
}
#toggle-sidebar-btn:hover{
    background:var(--header-icon-btn-hover-bg);
    color:var(--header-text-color);
}
#toggle-sidebar-btn .fa-chevron-left{display:none}
.sidebar-collapsed #toggle-sidebar-btn .fa-bars{display:none}
.sidebar-collapsed #toggle-sidebar-btn .fa-chevron-left{display:inline-block}
*/

#api-provider-display,
.status-item,
.model-selection-container .form-select-sm,
.theme-selection-container .form-select-sm {
    padding:.2rem .6rem;
    font-size:.8rem;
    color:var(--header-info-text-color);
    background:var(--header-info-bg);
    border-radius:4px;
}
.header-right .form-select-sm {
    border:1px solid var(--header-info-border-color);
    line-height: 1.4;
}
.header-right .form-select-sm:focus {
    background:var(--header-info-bg);
    border-color: var(--primary-light);
    box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb), 0.25);
    color:var(--header-info-text-color);
}
.header-right .form-select-sm option {
    background-color: var(--card-bg); /* Options should use card-bg from current theme */
    color: var(--text-color);         /* Options should use text-color from current theme */
}


.status-indicator{width:9px;height:9px;border-radius:50%;flex-shrink:0;border:1px solid rgba(0,0,0,.2)}
.status-indicator.connected{background:#4caf50;box-shadow:0 0 5px rgba(76,175,80,.7);animation:pulseConnected 2s infinite}
.status-indicator.disconnected{background:#f44336;box-shadow:0 0 5px rgba(244,67,54,.7)}

/* =====================================================================
   Tabs Navigation (Used by old HTML, new one uses dropdown)
   ===================================================================== */
.tabs-container{
    display:flex;
    flex-shrink:0;
    overflow-x:auto;
    overflow-y:hidden;
    padding:0 1.5rem;
    background:var(--tab-bg);
    border-bottom:1px solid var(--tab-bottom-border-color);
    box-shadow:inset 0 -2px 4px rgba(0,0,0,.04);
    -webkit-overflow-scrolling:touch
}
.tab-item{
    display:inline-flex;
    align-items:center;
    gap:.4rem;padding:.7rem 1.2rem;
    margin-bottom:-1px;
    border:none;
    border-bottom:3px solid transparent;
    background:none;
    color:var(--tab-text-color);
    font-weight:500;
    white-space:nowrap;
    cursor:pointer;
    transition:color .2s ease,border-color .2s ease
}
.tab-item i{font-size:.9em;opacity:.8}
.tab-item:hover{color:var(--tab-hover-text-color)}
.tab-item.active{
    color:var(--tab-active-text-color);
    border-bottom-color:var(--tab-active-border-color);
}
.tab-item.active i{opacity:1}

/* =====================================================================
   Content Wrappers & Main Layout (Updated for index.html structure)
   ===================================================================== */
.main-content { /* This is the direct child of .container-fluid and parent of .left-panel & .right-panel */
    display: flex !important;
    flex-grow: 1 !important;
    /* MODIFIED: Removed gap for Issue 3 */
    gap: 0; /* Small gap between left and right panels */
    padding: 0.5rem; /* Padding around the main content area */
    overflow: hidden; /* Prevent layout issues */
    min-height: 0; /* For flexbox to work correctly in some browsers */
}

.left-panel {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* Scroll for content within left panel */
    background-color: var(--bs-body-tertiary); /* Bootstrap variable */
    border: 1px solid var(--bs-border-color-translucent); /* Bootstrap variable */
    border-radius: var(--bs-border-radius); /* Bootstrap variable */
    padding: 0.75rem;
    transition: width 0.3s ease, min-width 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
    background:var(--card-bg); 
    border:1px solid var(--panel-border-color);
}

.right-panel {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* Scroll for content within right panel */
    background-color: var(--bs-body-tertiary);
    border: 1px solid var(--bs-border-color-translucent);
    border-radius: var(--bs-border-radius);
    padding: 0.75rem;
    min-width: 0; /* Allow shrinking */
    background:var(--card-bg);
    border:1px solid var(--panel-border-color);
    padding-left: 0 !important;
    padding-right: 0 !important;

}

/* Styles for when sidebar is collapsed */
.main-content.sidebar-collapsed .left-panel {
    width: 0 !important;
    min-width: 0 !important;
    padding-left: 0;
    padding-right: 0;
    opacity: 0;
    overflow: hidden;
    border: none;
    /* MODIFIED: margin-right might not be needed if gap is 0 on parent. Test this. */
    /* margin-right: -0.5rem; */ /* Compensate for gap if needed */
}

/* Feature content blocks within panels */
.feature-content-block {
    display: none; /* Hidden by default */
    flex-direction: column;
    flex-grow: 1; /* Take available space */
    height: 100%;
    overflow: hidden; /* Manage overflow within the block */
}
.feature-content-block.active {
    display: flex !important; /* Show active block */
}


/* Panel Titles and Headers */
.panel-title { /* General panel titles if used inside .left-panel or .right-panel */
    font-size: 1rem;
    font-weight: 500;
    color: var(--panel-title-text-color);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--panel-title-border-color);
}
.panel-header { /* Specific for left panel history sections */
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    flex-shrink: 0;
}
.panel-header .panel-title { /* Override for panel-title inside panel-header */
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
    font-size: 0.875rem; /* Small */
    font-weight: bold;
}

/* Left Panel Top Controls */
.left-panel-top-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.5rem;
    margin-bottom: 0.5rem;
    border-bottom: 1px solid var(--bs-border-color-translucent);
    flex-shrink: 0;
}
.left-panel-top-controls .btn-icon {
    padding: 0.25rem 0.4rem !important;
    font-size: 1em;
    color: var(--bs-secondary-color); /* Bootstrap variable for icon color */
    background: transparent !important;
    border: none !important;
    line-height: 1;
    cursor: pointer;
}
.left-panel-top-controls .btn-icon:hover {
    color: var(--bs-primary); /* Bootstrap primary color on hover */
}
.left-panel-top-controls .search-history-input {
    flex-grow: 1;
    margin: 0 0.5rem;
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
    border-radius: var(--bs-border-radius-sm);
    border: 1px solid var(--bs-border-color);
    background-color: var(--bs-body-bg); /* Use Bootstrap body background */
    color: var(--bs-body-color); /* Use Bootstrap body text color */
}


/* History List Styling */
.history-list {
    list-style: none;
    padding-left: 0;
    margin-bottom: 0;
    flex-grow: 1; /* Allow list to take available space */
    overflow-y: auto; /* Enable scrolling for the list itself */
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar-thumb-color) var(--scrollbar-track-color);
}
.history-list::-webkit-scrollbar{width:5px}
.history-list::-webkit-scrollbar-thumb{
    background:var(--scrollbar-thumb-color);
    border-radius:5px
}

.history-item{
    display:flex;align-items:center;justify-content:space-between;gap:.5rem;
    margin-bottom:.5rem;padding:.5rem;
    background:var(--history-item-bg);
    border:1px solid var(--history-item-border-color);
    border-radius:var(--bs-border-radius-sm); /* Use Bootstrap's small border radius */
    border-left:3px solid transparent;
    cursor:pointer;transition:var(--transition)
}
.history-item:hover{
    background:var(--history-item-hover-bg);
    transform:translateY(-1px);
    box-shadow:var(--shadow);
}
.history-item-content-wrapper{flex:1 1 auto;overflow:hidden;margin-right:.5rem;display:flex;flex-direction:column;gap:.1rem}
.history-item-content-wrapper div{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:0.8rem;}
#ss-history-list .history-item img{width:100%;max-width:80px;height:auto;margin-bottom:.2rem;border-radius:3px;box-shadow:0 1px 2px rgba(0,0,0,.07)}
#ss-history-list .history-item-text{font-size:.7rem;color:var(--history-item-text-secondary-color)}

.chat-history-item .history-item-content-wrapper>div:first-child, /* Title */
.voice-history-item .history-item-content-wrapper>div:first-child{ /* Title/Timestamp */
    font-weight:500;font-size:.8rem; color: var(--history-item-text-main-color);
}
.chat-history-item .history-item-content-wrapper>div:last-child, /* Timestamp */
.voice-history-item .history-item-content-wrapper>div:last-child{ /* Transcript snippet */
    font-size:.7rem;color:var(--history-item-text-secondary-color);
}

.history-item.active-session, /* For chat/voice active items */
#ss-history-list .history-item.active-screenshot-item{ /* For screenshot active item */
    background:var(--history-item-active-bg)!important;
    border-left-color:var(--history-item-active-border-color)!important;
}
.history-item.active-session .history-item-content-wrapper>div:first-child,
#ss-history-list .history-item.active-screenshot-item .history-item-content-wrapper>div:first-child {
    color: var(--panel-title-text-color); /* Or a specific active text color */
}


.history-item-actions{flex-shrink:0;display:flex;align-items:center;gap:.3rem}
.delete-history{ /* This class is used by JS createDeleteButton */
    width:22px;height:22px;font-size:12px;
    display:inline-flex;align-items:center;justify-content:center;
    border:none;border-radius:50%;background:transparent;
    color:var(--history-item-delete-btn-color);
    cursor:pointer;opacity:.5;transition:var(--transition)
}
.history-item:hover .delete-history{opacity:1}
.delete-history:hover{
    background:var(--history-item-delete-btn-hover-bg);
    color:var(--history-item-delete-btn-hover-color);
}

/* AI Analysis / Chat Area in Right Panel */
.analysis-card, .chat-card, .voice-card { /* These are containers within right panel's feature blocks */
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    height: 100%; /* Ensure they fill parent */
    overflow: hidden;
}

.ai-analysis { /* This is the actual scrollable content area */
    flex:1 1 auto;padding:.75rem 1rem;
    font-size:.9rem;line-height:1.7;
    color:var(--ai-analysis-text-color);
    background:var(--ai-analysis-bg);
    border:1px solid var(--ai-analysis-border-color);
    border-radius: var(--bs-border-radius-sm); /* Match Bootstrap */
    overflow-y:auto;min-height:150px; /* Minimum height */
    scrollbar-width:thin;
    scrollbar-color:var(--scrollbar-thumb-color) var(--scrollbar-track-color);
}
.ai-analysis::-webkit-scrollbar{width:5px}
.ai-analysis::-webkit-scrollbar-thumb{
    background:var(--scrollbar-thumb-color);
    border-radius:5px
}
.chat-messages{
    display:flex;
    flex-direction:column;
    gap:.5rem;
    padding-bottom:1rem;
    padding-left: 0 !important;
    padding-right: 0 !important;

}

/* Message Styling (User, AI, System, Error) */
.user-message,.ai-message,.error-message,.system-message,.ai-thinking{
    max-width:90%;margin-bottom:.5rem;padding:.6rem .9rem; /* Slightly smaller padding */
    font-size:.9rem;line-height:1.6;border-radius:10px; /* Slightly smaller radius */
    box-shadow:var(--shadow);
    word-wrap:break-word
}
.user-message{
    margin-left:auto;
    background:var(--user-message-bg);
    color:var(--user-message-text-color);
    border-bottom-right-radius:3px
}

/* ① 彻底去掉聊天容器自己的左右 padding —— 盖掉 Bootstrap 的 p-2 */
#chat-chat-history{
    padding-left: 0 !important;
    padding-right: 0 !important;
    scrollbar-gutter: stable;
}

.ai-message{
    /* —— 去气泡 —— */
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;

    /* —— 布局 —— */
    width: 100%;
    max-width: none !important;   /* ★ 关键：撕掉 90% */
    box-sizing: border-box;
    text-align: left;

    /* —— 留白 —— */
    margin-block: .75rem;         /* 上下间距 */
    padding-inline: clamp(1rem, 8vw, 8rem);  /* 左右随屏宽 1–4 rem */
}



.ai-message strong{
    color:var(--ai-message-strong-color);
    display: block;
    margin-bottom: .25rem;
}
.error-message{
    background:var(--error-message-bg);
    color:var(--error-message-text-color);
    border:1px solid var(--error-message-border-color);
    margin-right:auto
}
.system-message{
    width:auto;margin:.5rem auto;font-size:.8em;font-style:italic;
    background:none;box-shadow:none;
    color:var(--system-message-text-color);
    text-align:center
}
.ai-thinking{
    display:inline-flex;align-items:center;width:fit-content;margin-right:auto;
    background:var(--ai-thinking-bg);
    color:var(--ai-thinking-text-color);
    font-style:italic;border-bottom-left-radius:3px
}
.ai-thinking i{margin-right:.5em;animation:fa-spin 1.5s linear infinite}

.attached-file{
    display:inline-block;margin-top:.4rem;padding:.2rem .6rem;font-size:.8em;
    color:var(--attached-file-text-color);
    background:var(--attached-file-bg);
    border:1px solid var(--attached-file-border-color);
    border-radius:4px;word-break:break-all
}
.attached-file i{margin-right:.3em}

/* Chat Input Area (Updated for index.html structure) */
.chat-input-area {
    width: 100%;
    max-width: 800px; /* Max width for the input bar area */
    margin-left: auto;
    margin-right: auto;
    margin-top: auto; /* Push to bottom of its container */
    padding: 0.5rem;
    flex-shrink: 0; /* Prevent shrinking */
}
.chat-input-bar {
    display: flex;
    align-items: center; /* Align items vertically */
    background-color: var(--bs-tertiary-bg);
    border-radius: 22px; /* Rounded bar */
    padding: 0.3rem 0.5rem;
    border: 1px solid var(--bs-border-color);
}
body.theme-dark .chat-input-bar { /* Dark theme specific for input bar */
    background-color: var(--bs-gray-700, #343a40); /* Fallback if BS var not available */
    border-color: var(--bs-gray-600, #495057);
}
#chat-attach-file-btn { /* For the "+" button */
    flex-shrink: 0;
    color: var(--bs-secondary-color);
    padding: 0.375rem 0.6rem !important;
    margin-right: 0.25rem;
    font-size: 1.1rem; /* Make icon a bit larger */
    background: transparent !important;
    border: none !important;
}
#chat-attach-file-btn label { cursor: pointer; display: block; }

#chat-chat-input { /* Textarea */
    flex-grow: 1;
    border: none;
    background-color: transparent;
    box-shadow: none !important;
    resize: none;
    min-height: 38px; /* Approx 1 line */
    max-height: 120px; /* Approx 4-5 lines */
    overflow-y: auto;
    padding: 0.375rem 0.5rem;
    margin: 0;
    line-height: 1.5;
    color: var(--bs-body-color); /* Use Bootstrap's body text color */
}
body.theme-dark #chat-chat-input {
    color: var(--text-color); /* Ensure light text in dark mode for custom var */
}
#chat-chat-input::placeholder {
    color: var(--bs-secondary-color); /* Placeholder color */
    opacity: 0.7;
}
body.theme-dark #chat-chat-input::placeholder {
    color: var(--light-text);
    opacity: 0.6;
}

#chat-send-chat { /* Send button */
    flex-shrink: 0;
    color: var(--bs-primary);
    padding: 0.375rem 0.6rem !important;
    font-size: 1.1rem; /* Make icon a bit larger */
    margin-left: 0.25rem;
    background: transparent !important;
    border: none !important;
}

.chat-options {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: 0.25rem; /* Small space above options */
    font-size: 0.8rem; /* Smaller text for options */
}
.streaming-toggle {
    color: var(--bs-secondary-color);
}
body.theme-dark .streaming-toggle {
    color: var(--light-text);
}
.streaming-toggle .form-check-input {
    margin-top: 0.1em; /* Align checkbox better */
}


#chat-upload-preview{max-height:80px;overflow-y:auto;margin-bottom:.25rem; font-size: 0.8rem;}
.preview-item{
    display:flex;align-items:center;justify-content:space-between;
    margin-bottom:.2rem;padding:.3rem .5rem;
    background:var(--preview-item-bg);
    border:1px solid var(--preview-item-border-color);
    border-radius:4px
}
.file-info{
    display:flex;align-items:center;overflow:hidden;margin-right:.5rem;
    color:var(--preview-item-text-color);
    white-space:nowrap;text-overflow:ellipsis
}
.file-info i{margin-right:.4rem;color:var(--preview-item-icon-color);font-size:.9em}
.remove-file{
    flex-shrink:0;padding:0 .2rem;font-size:1.1em;background:none;border:none;
    color:var(--remove-file-btn-text-color);
    cursor:pointer;opacity:.7;transition:var(--transition)
}
.remove-file:hover{
    color:var(--remove-file-btn-hover-text-color);
    opacity:1
}

/* Voice Controls */
.voice-controls{
    flex-shrink:0;display:flex;justify-content:center;gap:1rem;padding-top:1rem;
    border-top:1px solid var(--bs-border-color-translucent);
}
#voice-start-recording i,#voice-stop-recording i{margin-right:.5rem}

/* =====================================================================
   Overlay / Cropper
   ===================================================================== */
.overlay{
    position:fixed;inset:0;display:none;justify-content:center;align-items:center;
    padding:1rem;
    background:var(--overlay-backdrop-bg);
    z-index:1000;animation:fadeIn .3s forwards
}
.overlay.hide{animation:fadeOut .3s forwards}
.overlay-content{
    position:relative;display:flex;flex-direction:column;
    width:95%;max-width:1000px;max-height:95vh;overflow:hidden;
    background:var(--overlay-content-bg);
    border-radius:var(--border-radius);
    box-shadow:0 5px 20px rgba(0,0,0,.4)
}
.close-btn{
    position:absolute;top:.5rem;right:.5rem;width:30px;height:30px;
    font-size:1.2rem;line-height:30px;text-align:center;
    color:var(--overlay-close-btn-text-color);
    background:var(--overlay-close-btn-bg);
    border:none;border-radius:50%;cursor:pointer;transition:var(--transition);z-index:1010
}
.close-btn:hover{background:var(--overlay-close-btn-hover-bg)}

.image-container{
    position:relative;display:flex;align-items:center;justify-content:center;
    flex:1 1 auto;min-height:200px;overflow:auto;
    background:var(--overlay-image-container-bg);
}
#overlay-image{display:block;max-width:100%;max-height:calc(95vh - 180px);object-fit:contain;cursor:crosshair;user-select:none;-webkit-user-drag:none}

.selection-box{
    position:absolute;
    border:2px dashed var(--selection-box-border-color);
    background:var(--selection-box-bg-color);
    box-shadow:0 0 0 9999px var(--selection-box-shadow-color);
    pointer-events:auto
}
.resize-handle{ /* This handle might not be explicitly in your HTML but is common for croppers */
    position:absolute;bottom:-15px;right:-15px;width:30px;height:30px;border-radius:50%;
    background:var(--resize-handle-bg);
    cursor:nwse-resize;pointer-events:auto;z-index:1000
}
.overlay-controls{
    flex-shrink:0;padding:1rem;
    background:var(--overlay-controls-bg);
    border-top:1px solid var(--overlay-controls-border-color);
}
.crop-info{margin-bottom:.75rem;font-size:.85rem;color:var(--crop-info-text-color);text-align:center;min-height:1.2em}

.prompt-container{margin-bottom:1rem}
.prompt-container label{display:block;margin-bottom:.3rem;font-size:.9rem;font-weight:500; color: var(--text-color)}
.prompt-container input{
    width:100%;padding:.6rem;font-family:var(--font-family-sans-serif);
    background: var(--input-bg);
    color: var(--input-text-color);
    border:1px solid var(--input-border-color);
    border-radius:4px
}
.prompt-container input:focus{
    border-color:var(--input-focus-border-color);
    box-shadow:0 0 0 3px var(--input-focus-shadow);
    outline:none
}
.buttons{display:flex;justify-content:flex-end;gap:.75rem}

/* -- 查看原图浮层专用补丁 -- */
#viewer-overlay .image-container img {
  max-width: 95vw;
  max-height: 95vh;
  cursor: zoom-out;
}
#viewer-overlay .selection-box,
#viewer-overlay .resize-handle { display:none !important; }


/* =====================================================================
   Utility Buttons (General styling, specific Bootstrap classes used in HTML will take precedence)
   ===================================================================== */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.6rem 1.2rem;font-size:.9rem;font-weight:500;line-height:1.5;white-space:nowrap;border:none;border-radius:6px;cursor:pointer;transition:var(--transition);font-family:var(--font-family-sans-serif)}
.btn i{line-height:1}
.btn-primary{
    color:var(--button-primary-text-color);
    background:linear-gradient(135deg,var(--primary-color)0%,var(--primary-dark)100%);
    box-shadow:0 2px 4px rgba(0,0,0,.1)
}
.btn-primary:hover{
    background:linear-gradient(135deg,var(--primary-dark)0%,var(--primary-color)100%);
    box-shadow:0 4px 8px rgba(0,0,0,.15);transform:translateY(-1px)
}
/* Other .btn- variants will largely come from Bootstrap or your overrides */
button:disabled{opacity:.65;cursor:not-allowed;transform:none!important;box-shadow:none!important}

/* =====================================================================
   Markdown Content / Code Blocks
   ===================================================================== */
.message-content{font-size:inherit;line-height:1.75;color:inherit;text-align:left;word-wrap:break-word}
.message-content h1{font-size:1.6em; margin-top: 0.8em; margin-bottom: 0.4em;}
.message-content h2{font-size:1.4em; margin-top: 0.7em; margin-bottom: 0.35em;}
.message-content h3{font-size:1.2em; margin-top: 0.6em; margin-bottom: 0.3em;}
.message-content h4{font-size:1.1em; margin-top: 0.5em; margin-bottom: 0.25em;}
.message-content h5{font-size:1em;font-weight:bold; margin-top: 0.4em; margin-bottom: 0.2em;}
.message-content h6{font-size:.9em;font-weight:bold;color:var(--light-text); margin-top: 0.3em; margin-bottom: 0.15em;}
.message-content p{margin-bottom:.8em}
.message-content ul,.message-content ol{margin-bottom:.8em;padding-left:1.5em} /* Reduced padding */
.message-content code:not(pre code){
    font-family:var(--font-family-monospace);
    background:var(--code-bg);
    color:var(--code-text-color);
    padding:.1em .3em;font-size:.8em;border-radius:3px /* Smaller padding and font */
}
.message-content pre{
    position:relative;margin:.8em 0;padding:0.8em;font-size:.85em; /* Slightly smaller */
    font-family:var(--font-family-monospace);
    background: var(--pre-bg);
    color: var(--pre-text-color);
    border:1px solid var(--pre-border-color);
    border-radius:var(--bs-border-radius-sm);overflow-x:auto /* Match Bootstrap radius */
}
.message-content pre code{display:block;background:transparent!important;color: inherit; white-space:pre; padding: 0;} /* Remove padding from code inside pre */

.copy-code-button{
    position:absolute;top:.2em;right:.2em;font-size:.75em;padding:.2em .4em; /* Smaller button */
    color:var(--copy-button-text-color);
    background:var(--copy-button-bg);
    border:1px solid var(--copy-button-border-color);
    border-radius:3px;cursor:pointer;opacity:0;transition:opacity .2s,background .2s;z-index:10
}
.message-content pre:hover .copy-code-button{opacity:.7}
.copy-code-button:hover{
    opacity:1;
    background:var(--copy-button-hover-bg);
    color:var(--copy-button-hover-text-color);
}
.copy-code-button.copied{
    background:var(--copy-button-copied-bg);
    color:var(--copy-button-hover-text-color);opacity:1
}
.copy-code-button.copy-failed{
    background:var(--copy-button-failed-bg);
    color:var(--copy-button-hover-text-color);opacity:1
}

.message-content table{
    width:auto;max-width:100%;
    border:1px solid var(--table-border-color);
    border-collapse:collapse;overflow-x:auto;display:block;margin:1em 0;font-size:.9em
}
.message-content th,.message-content td{
    padding:6px 10px; /* Smaller padding */
    border:1px solid var(--table-border-color);
    text-align:left
}
.message-content th{
    background:var(--table-header-bg);
    font-weight:600
}
.message-content tr:nth-child(even){background:var(--table-row-even-bg)}
.message-content blockquote{
    margin:.8em 0;padding:.5em 1em;
    color:var(--blockquote-text-color);
    background:var(--blockquote-bg);
    border-left:.25em solid var(--blockquote-border-color);
    font-size: 0.9em; /* Slightly smaller blockquote */
}




/* LaTeX / KaTeX */
.message-content .katex{font-size:1em;line-height:normal;vertical-align:baseline;text-rendering:optimizeLegibility;text-align:initial}
.message-content .katex-display{
    display:block;margin:1em auto;padding:.5em;overflow-x:auto;text-align:center;line-height:normal;
    background:var(--katex-display-bg);
    border-radius:4px;max-width:100%;box-sizing:border-box;font-size:1.05em
}
.message-content .katex-display::-webkit-scrollbar{height:6px;background:transparent}
.message-content .katex-display::-webkit-scrollbar-thumb{
    background:var(--scrollbar-thumb-color);
    border-radius:3px
}
.message-content .katex-display::-webkit-scrollbar-thumb:hover{background:#aaa}
.message-content .katex-display{
    scrollbar-width:thin;
    scrollbar-color:var(--scrollbar-thumb-color) var(--scrollbar-track-color);
}

/* =====================================================================
   Responsive Breakpoints
   ===================================================================== */
@media(max-width:992px){.ai-message,.user-message{max-width:95%}}
@media(max-width:768px){
    body{font-size:.9rem}
    .left-panel{ /* On small screens, left panel might take full width if not handled by JS for dropdown */
        /* width:100%!important;max-width:none!important;min-width:0!important;margin-right:0!important;margin-bottom:1rem!important */
        /* Current HTML uses d-flex, so this might not be needed if display:none is used for collapsed */
    }
    /* .main-content{flex-direction:column!important} */ /* This would stack left/right panels */
    .main-content.sidebar-collapsed .left-panel{ /* Ensure it hides properly */
        /* height:0;padding:0;margin-bottom:0;border:none */
    }
    .header-left h1 { font-size: 1.2rem; }
    .header-left p { display: none; } /* Hide subtitle on very small screens */
    .header-right { gap: 0.5rem; }
    .header-right .form-select-sm { font-size: 0.75rem; min-width: auto; }
}
@media(max-width:480px){
    .ai-message,.user-message{max-width:98%}
    .message-content .katex{font-size:.9em}
    .message-content .katex-display{font-size:.95em}
    .header { padding: 0.5rem 0.75rem; }
    .chat-input-area { padding: 0.25rem; }
}

/* =====================================================================
   Keyframes
   ===================================================================== */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}
@keyframes fa-spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@keyframes pulseConnected{0%{box-shadow:0 0 3px rgba(76,175,80,.4)}50%{box-shadow:0 0 8px rgba(76,175,80,.8)}100%{box-shadow:0 0 3px rgba(76,175,80,.4)}}

/* Theme Selector Specific Styling (already covered by .header-right .form-select-sm generally) */
/* #theme-selector might not need extra rules if general .form-select-sm in header is styled */

.ai-message{
    max-width: none !important;   /* 彻底取消 90% 限制 */
}

#viewer-close-btn{
  position:fixed;            /* 相对窗口 */
  top:16px;
  right:24px;
  width:36px;height:36px;
  line-height:34px;
  font-size:1.6rem;
  background:#0008;
  color:#fff;
  border-radius:50%;
  z-index:1100;
  cursor:pointer;
}
#viewer-close-btn:hover{background:#000c}

